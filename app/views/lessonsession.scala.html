@import tags._
@import tools.Utils

@(lesson: Lesson, lessonSessions: List[LessonSession], pageIndex: Integer, totalAmount: Integer)

@diff(d1: Date, d2: Date) = @{
  	Utils.differentDateTimeByMins(d1, d2)
}

@createlessonframe(lesson, 2){
	<link rel="stylesheet" media="screen" href="@routes.Assets.versioned("stylesheets/simplePagination.css")">
	<link rel="stylesheet" media="screen" href="@routes.Assets.versioned("stylesheets//bootstrap-datetimepicker.min.css")">
	<script src="@routes.Assets.versioned("javascripts/jquery.simplePagination.js")" type="text/javascript"></script>
	<script src="@routes.Assets.versioned("javascripts/moment.js")" type="text/javascript"></script>
	<div class="dash-detail-header">
		<p class="lesson-sec-title">课时管理</p>
		<a class="btn btn-success" data-toggle="modal" data-target="#lesson-session-model"><i class="fa fa-plus"></i>新建课时</a>
	</div>
	
	@if(lessonSessions == null || lessonSessions.size == 0){
		<p class="empty">暂无课时内容～</p>
	}else{
		<table class="table table-striped table-hover">
		    <thead>
		      <tr>
		        <th>#</th>
		        <th>课时标题</th>
		        <th>开课时间</th>
		        <th>时长</th>
		        <th>状态</th>
		      </tr>
		    </thead>
		    <tbody>
		    	@for(index <- 0 until lessonSessions.size){
				    <tr class="paginate">
						<th>@((pageIndex-1) * LessonSession.PAGE_SIZE + index+1)</th>
						<td>@lessonSessions(index).title</td>
						<td>@lessonSessions(index).startDatetime.format("HH:mm, dd MMM yyyy")</td>
						<td>@lessonSessions(index).duration 分钟</td>
						<td>
							@diff(new Date(), lessonSessions(index).startDatetime) match {
								case a if a <= -lessonSessions(index).duration => {<span>已结束</span>}
								case a if a > -lessonSessions(index).duration && a <= 0 => {<a class="btn broadcast-btn" href="@routes.LessonController.broadcastLessonSession(lessonSessions(index).id)">直播中...</a>}
								case a if a > 0 && a <= 30 => {<a class="btn broadcast-btn" href="@routes.LessonController.broadcastLessonSession(lessonSessions(index).id)">开始直播</a>}
								case a if a > 30 => {<span>直播未开始</span>}
							}
						</td>
			        </tr>
				}
		    </tbody>
		</table>
		<div id="page-nav"></div>
		<form id="page-form" class="hidden" action="@routes.LessonController.lessonSession()" method="get">
			<input type="hidden" name="lessonId" value="@lesson.id"/>
			<input id="page-offset" type="hidden" name="offset" value="0"/>
		</form>
	}
	
	<div class="modal fade" id="lesson-session-model" role="dialog">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
	        <h4 class="modal-title">添加新课时</h4>
	      </div>
	      <form id="lesson-sec-form" action="@routes.LessonController.saveLessonSession()" method="POST">
	      	<div class="modal-body">
	      		<input name="lessonId" value="@lesson.id" type="hidden"/>
		    	<div class="form-group">
		    		<label>课时标题</label>
		      		<input class="form-control" type="text" name="title" placeholder="课时标题"/>
		      	</div>
		      	<div class="form-group">
		      		<label>课时简介</label>	
		      		<textarea class="form-control" name="brief" rows="2" placeholder="课时简介"></textarea>
		      	</div>
		      	<div class="form-group">
					<label for="start-datepicker">开课时间:</label>
					<input type="text" id="start-datepicker" class="form-control" name="startDatetime" data-date-format="YYYY-MM-DD HH:mm">
				</div>
				<div class="form-group">
					<label>直播时长:</label>
					<select class="form-control" name="duration">
					    <option value="30">30 分钟</option>
					    <option value="60">60 分钟</option>
					    <option value="90">90 分钟</option>
					    <option value="120">120 分钟</option>
					    <option value="150">150 分钟</option>
					</select>
				</div>
				<div class="form-group">
				    <input type="checkbox">
				    <input type="hidden" name="interactive" value="0">
				    <label>交互直播 <span class="note">（交互直播允许学生和老师直接交流，直播室人数上线为10人）</span></label>
				</div>
		      </div>
		      <div class="modal-footer">
		      	<div class="form-group">
		        	<input id="save-lesson-sec-btn" type="submit" class="btn btn-success" value="创建课时">
		        </div>
		      </div>
	      </form>
	    </div>
	  </div>
	</div>
	
	<script src="@routes.Assets.versioned("javascripts/jquery.ui.widget.js")" type="text/javascript"></script>
	<script src="@routes.Assets.versioned("javascripts/bootstrap-datetimepicker.js")" type="text/javascript"></script>
	<script type="text/javascript">
		$(function(){
			$('#start-datepicker').datetimepicker({
				minuteStepping: 30
			});
			
			$('#lesson-sec-form input[type=checkbox]').change(function(){ 
		        var v = $(this).is(':checked') ? 1 : 0;
		        $(this).next('input[type=hidden]').val(v);
		    });
			
			$("#lesson-sec-form").validate({
		        rules: {
		        	title:{
		            	minlength: 6,
		                maxlength: 50,
		            	required:true
		            },
		            brief:{
		            	required:true
		            }
		        },
		        highlight: function (element) {
		            $(element).closest('.form-group').removeClass('has-success').addClass('has-error');
		        },
		        unhighlight: function (element) {
		            $(element).closest('.form-group').removeClass('has-error').addClass('has-success');
		        },
		        submitHandler: function(form) {
		        	var spinner = $('<i class="glyphicon glyphicon-refresh glyphicon-spinner spinner"></i>');
		        	$('#save-lesson-sec-btn').after(spinner);
		        	$('#save-lesson-sec-btn').css('color', 'transparent');
		        	$('#save-lesson-sec-btn').attr("disabled", true);
		        	
		        	form.submit();
		        }
		    });
			
			var pageParts = $(".paginate");
		    var numPages = pageParts.length;
		    var perPage = @LessonSession.PAGE_SIZE;
		    
		    pageParts.slice(perPage).hide();
		    $("#page-nav").pagination({
		        items: @totalAmount,
		        itemsOnPage: perPage,
		        currentPage: @pageIndex,
		        cssStyle: "light-theme",
		        onPageClick: function(pageNum) {
		            var start = perPage * (pageNum - 1);
		            var end = start + perPage;
		            
		            $('#page-offset').val(start);
		            $('form#page-form').submit();
		        }
		    });
	   	});
	</script>
}