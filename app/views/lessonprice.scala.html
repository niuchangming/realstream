@import tags._

@(lesson: Lesson)

@createlessonframe(lesson, 5){
	<link rel="stylesheet" media="screen" href="@routes.Assets.versioned("stylesheets//bootstrap-datetimepicker.min.css")">
    <script src="@routes.Assets.versioned("javascripts/jquery.multi-select.js")" type="text/javascript"></script>
    <script src="@routes.Assets.versioned("javascripts/moment.js")" type="text/javascript"></script>
	<script src="@routes.Assets.versioned("javascripts/bootstrap-datetimepicker.js")" type="text/javascript"></script>
	<script type="text/javascript">
		$(function(){
			$('#start-datepicker').datetimepicker({
				@if(lesson.offerStartDate != null) {defaultDate: '@lesson.offerStartDate.format("yyyy-MM-dd")'}
			});		
			
			$('#end-datepicker').datetimepicker({
				@if(lesson.offerEndDate != null){defaultDate: '@lesson.offerEndDate.format("yyyy-MM-dd")'}
			});
			
			$('.expand-cell-header').on('click', function(){
				var expandWrap = $(this).parent();
				var icon = expandWrap.find('i.fa');
				if(expandWrap.hasClass('expend')){
					icon.removeClass('fa-angle-up');
					icon.addClass('fa-angle-down');					
				}else{
					icon.removeClass('fa-angle-down');
					icon.addClass('fa-angle-up');
				}
				
				expandWrap.toggleClass('expend');	
			});
			
			$('#sel-session').multiSelect({
				afterSelect: function(values){
					var amount = $('.ms-selection').find('li.ms-selected').length;
				    if(amount > 3){
				    	showAlertToast("试听课时不可以超过3节！", "alert-warning");
				    	$('#sel-session').multiSelect('deselect', values);
				    }
				}
			});
			
			$('.add-more-btn').on('click', function(){
				$('.popover-select').removeClass('hide');
			});
			
			$(document).click(function(e) { 
				if(e.target.className != 'popover-select' && e.target.className != 'add-more-btn' 
						&& $(e.target).parents('.popover-select').length == 0 && $(e.target).parents('.ms-selection').length == 0){
					var popover = $('.popover-select');
					if(!popover.hasClass('hide')){
						$('.popover-select').addClass('hide'); 	
					}
				}
			});
			
			$('#save-lesson-btn').on('click', function(){
				$("#lesson-price-form").submit();
			});
			
			$.validator.addMethod("largerThanStartDate", function(value, element) {
	            var startDate = $('#start-datepicker').val();
	            return Date.parse(startDate) <= Date.parse(value) || value == "";
	        }, "End date must be after start date");
			
			$("#lesson-price-form").validate({
		        rules: {
		        	price:{
		        		number: true,
		            	required:true
		            },
		            offerPrice:{
		            	number: true
		            },
		            offerEndDate:{
		            	largerThanStartDate: true
		            }
		        },
		        highlight: function (element) {
		            $(element).closest('.form-group').removeClass('has-success').addClass('has-error');
		        },
		        unhighlight: function (element) {
		            $(element).closest('.form-group').removeClass('has-error').addClass('has-success');
		        },
		        submitHandler: function(form, event) {
		        	event.preventDefault();
		        	var spinner = $('<i class="glyphicon glyphicon-refresh glyphicon-spinner spinner"></i>');
		        	
		        	$('#save-lesson-btn').after(spinner);
		        	$('#save-lesson-btn').attr("disabled", true);
		        	$('#save-lesson-btn').text("");
		        	
		        	$.ajax({
		                url: "@routes.LessonController.saveLessonPrice()",
		                type: "POST",
		                data: $(form).serialize(),
		                success: function(response, status) {
		                	var data = $.parseJSON(JSON.stringify(response));
		                	
		                	if(data.code != 0){
		                		showAlertToast(data.message, "alert-danger");
		                	}else{
		                		showAlertToast(data.message, "alert-success");
		                	}
		                	
		                	spinner.remove();
		                	$('#save-lesson-btn').attr("disabled", false);
		                	$('#save-lesson-btn').text("修改保存");
		                },
		                error: function(request, status, err){
		                	showAlertToast(err, "alert-danger");
		                	spinner.remove();
		                	$('#save-lesson-btn').attr("disabled", false);
		                	$('#save-lesson-btn').text("修改保存");
		                }
		            });
		        }
		    });
	   	});
	</script>
	<div class="dash-detail-header">
		<p class="lesson-sec-title">价格设置</p>
	</div>
	<form id="lesson-price-form">
		<input type="hidden" name="lessonId" value="@lesson.id">
		<div class="form-group">
			<div class="form-label">
				<label>课程总价:</label>
			</div>
			<div class="form-input">
				<input type="text" class="form-control" name="price" placeholder="课程总价" value="@lesson.price.intValue()">
			</div>
			<span class="currency">RMB</span>
		</div>
		
		<div class="expand-cell-wrap">
		   <div class="expand-cell-header">
		      <div class="icon">
		         <i class="fa fa-angle-down"></i>
		      </div>
		      <p class="section-title">设置优惠价格</p>
		   </div>
		   <div class="expand-cell-detail">
		     <div class="form-group">
				<div class="form-label">
					<label>优惠价格:</label>
				</div>
				<div class="form-input">
					<input type="text" class="form-control" name="offerPrice" placeholder="优惠价格 (例如: 100)" value="@lesson.offerPrice.intValue()">
				</div>
				<span class="currency">RMB</span>
			 </div>
			 <div class="form-group">
			 	<div class="form-label">
					<label for="start-datepicker">开始日期:</label>
				</div>
				<div class="form-input">
					<input type="text" id="start-datepicker" class="form-control" name="offerStartDate" placeholder="开始日期" data-date-format="YYYY-MM-DD">
				</div>
				<span class="splitor">到</span>
				<div class="form-input">
					<input type="text" id="end-datepicker" class="form-control" name="offerEndDate" placeholder="结束日期" data-date-format="YYYY-MM-DD">
				</div>
			</div>
		   </div>
		</div>
		
		<div class="expand-cell-wrap">
		   <div class="expand-cell-header">
		      <div class="icon">
		         <i class="fa fa-angle-down"></i>
		      </div>
		      <p class="section-title">设置试听课时</p>
		   </div>
		   <div class="expand-cell-detail">
		   		<a class="add-more-btn">+添加免费课时</a>
		   </div>
		   
		   <div class="popover-select hide">
		   		<select multiple="multiple" id="sel-session" name="lessonSessions[]">
		   			@if(lesson.lessonSessions != null){
						@for(lessonSession <- lesson.lessonSessions) {
						  <option value='@lessonSession.id' @if(lessonSession.isTrial){selected}>@lessonSession.title</option>
						}
		   			}
			    </select>
				<div class="arrow"></div>	
			</div>
		</div>
	</form>
	
}










