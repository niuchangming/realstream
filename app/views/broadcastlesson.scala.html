@import tools.Constants

@(broadcastSession: BroadcastSession)

@scripts = {
	<script src="https://static.opentok.com/v2/js/opentok.min.js"></script>
    <script type="text/javascript">
    	var session = OT.initSession(@(Constants.TOKBOX_API_KEY), '@broadcastSession.sessionId');
    	
    	session.connect('@broadcastSession.token', function(error) {
			if (!error) {
      		    publish();
			} else {
				alert('There was an error connecting to the session(' +  error.code + "): " + error.message);
			}
  		});
    	
    	session.on('streamCreated', function(event) {
			session.subscribe(event.stream, 'publisher', {
				insertMode: 'append',
				width: '100%',
				height: '100%'
			});
  		});
    	
    	function publish(){
    		var publisher = OT.initPublisher('video_container', null, function(error) {
    		  if (error) {
    			  alert('Publisher initialized failed: ' + error);
    		  } else {
    			  session.publish(publisher, function(error) {
    					if (error) {
    						alert("Error: " + JSON.stringify(error));	
    					} else {
    						getBroadcastInfo();
    					}
					});
    		  }
    		});
    	}
    	
    	function getBroadcastInfo(){
    		$.ajax({
                url: "@routes.LessonController.getBroadcastInfo()",
                type: "POST",
                data: {
                	sessionId: '@broadcastSession.sessionId'
                },
                success: function(response, status) {
                	var data = $.parseJSON(JSON.stringify(response));
                	if(data.code != 0){
                		showAlertToast(data.message, "alert-danger");
                		setTimeout(function () {
                			getBroadcastInfo();
                        }, 5000)
                	} else{
                		showAlertToast(data.message, "alert-success");
                	}
                },
                error: function(request, status, err){
                	showAlertToast(err, "alert-danger");
                }
            });
    	}
    </script>
}

@main(scripts) {
	
	<div id="video_container"></div>
	
}