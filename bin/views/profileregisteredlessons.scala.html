@import tags._

@(user: User, lessons: List[Lesson])

@profileframe(user, 2){
	<div class="dash-detail-header">
		<p>学习进度</p>
	</div>
	@if(lessons.size() > 0){
		<div class="dash-detail-body">
			<div class="tab-ctn">
		      <div class="tab-course-list clear-fix">
		      	<a id="prev-btn" class="tab-move-btn tab-prev-btn">
					<i class="icon-font fa fa-angle-left"></i>
				</a>
				@for(index <- 0 until lessons.size){
					<div class="tab-item-ctn @if(index == 0){active}" data-ID='@lessons(index).id'>
						<p class="tab-title" title="工业设计考研复试逆袭第一经验分享">@lessons(index).title</p>
						<div class="process-ctn">	
			               <div class="process-full">
			                  <div class="process-done" style="width:0%;"></div>
			               </div>
		               		<span class="process-text">已学习0%</span>
			            </div>
			            <div class="course-date">
		            		<span>@if(lessons(index).startDatetime != null){@lessons(index).startDatetime.format("dd MMM yyyy")}</span>
			            	<span>至</span>
			            	<span>@if(lessons(index).endDatetime != null){@lessons(index).endDatetime.format("dd MMM yyyy")}</span>
			            </div>
					</div>         	
		        }
		        <a id="next-btn" class="tab-move-btn tab-next-btn">
					<i class="icon-font fa fa-angle-right"></i>
				</a>
		      </div>
		   </div>
		   <div class="details-ctn">
		      <div class="course-settings-ctn">
		         <div class="ctrl-item process"><span>学习进度：</span><span>0</span><span>%</span></div>
		         <div class="ctrl-item action-item before-line">
		            <a class="comments-ctn" data-toggle="modal" data-target="#comment-model">
		            	<i class="fa fa-commenting-o"></i>评价
		           	</a>
		         </div>
		         <a href="#" target="_blank" class="ctrl-item action-item before-line connect">
		         	<i class="fa a-volume-control-phone"></i><span>联系老师</span>
		       	 </a>
		         <a href="#" target="_blank" class="ctrl-item action-item before-line connect">
		         	<i class="fa fa-info-circle"></i><span>查看课程详情</span>
		      	 </a>
		      </div>
		      <div class="section-wrap">
		      	<span class="title">全部任务</span>
		      	<span class="nums">(共1节)</span>
			  </div>
		   </div>
		</div>
	}else{
		<p class="empty">您暂无任何课程～</p>
	}
	
	@comment(lessons)
	
   <script src="@routes.Assets.versioned("javascripts/jquery-dateFormat.min.js")" type="text/javascript"></script>
   <script src="@routes.Assets.versioned("javascripts/circle-progress.min.js")" type="text/javascript"></script>
   <script>
	$(function(){
		lessonMap = {};
		pageIndex = 0;
		tabContainerWidth = $('.tab-ctn').width() - 62;
		tabWidth = $('.tab-item-ctn').width();
		tabCount = Math.floor(tabContainerWidth / tabWidth);
		nextBtn = $('#next-btn');
		prevBtn = $('#prev-btn');
		lessonTabs = $('.tab-item-ctn');
		totalLessonCount = lessonTabs.length;
		
		if(@lessons.size() > 0){
			updatePage();
		}
		
		nextBtn.on('click', function(){
			pageIndex++;
			updatePage();
		});
		
		prevBtn.on('click', function(){
			pageIndex--;
			updatePage();
		});
		
		$('.tab-item-ctn').on('click', function(){
			$('.tab-item-ctn').each(function(){
				$(this).removeClass('active');
			});
			
			$(this).addClass('active');
			  
			var lessonId = $(this).attr('data-ID');
			
			if (!(lessonId in lessonMap)){
				loadLessonSession(lessonId);
			}else{
				updateSessionView(lessonMap[lessonId]);
			}
		});
		
	});
	
	function loadLessonSession(value){
		var spinner = $('<i class="glyphicon glyphicon-refresh glyphicon-spinner loading-bar"></i>');
		
		var lessonId = value;
		if(!lessonId && @lessons.size() > 0){
			lessonId = lessons.get(0).id;
		}
		
		$.ajax({
            url: "@routes.LessonController.lessonSessions()",
            type: "POST",
            dataType: "json",
            data: {
            	lessonId: lessonId
            },
            success: function(response, status) {
            	var data = $.parseJSON(JSON.stringify(response));
            	if(data.code != 0){
            		showAlertToast(data.message, "alert-danger");
            	}else{
            		lessonMap[lessonId] = data.data;
            		updateSessionView(lessonMap[lessonId]);
            	}
            	spinner.remove();
            },
            error: function(request, status, err){
            	spinner.remove();
            	showAlertToast(err, "alert-danger");
            }
        });
	}
	
	function updateSessionView(data){
		$('.detail-item-ctn').remove();
		$.each(data, function(key, lessonSession){
	        var lsView = '<div class="detail-item-ctn">';
	        lsView += '<div class="detail-item-body">';
	        lsView += '<div class="task-item-ctn">';
	        lsView += '<div class="icon"><span>' + key + '</span></div>';
	        lsView += '<div class="task-title">' + lessonSession.title + '</div>';
	        lsView += '<div class="sub-title">' + $.format.date(new Date(lessonSession.startDatetime), 'HH:mm, d MMM yyyy') + '</div>';

	        var diff = diffDate(new Date(), new Date(lessonSession.startDatetime));
	        if(diff <= -lessonSession.duration){
	        	lsView += '<div class="task-button-ctn">已结束</div>';
	        }else if(diff > -lessonSession.duration && diff <= 0){
	        	lsView += '<a class="btn task-button-ctn broadcast-btn" href="/broadcast/lessonSession/join?lessonSessionId='+ lessonSession.id +'">直播中...</a>';
	        }else if(diff > 0 && diff <= 30){
	        	lsView += '<a class="btn task-button-ctn broadcast-btn" href="/broadcast/lessonSession/join?lessonSessionId='+ lessonSession.id +'">开始直播</a>';
	        }else{
	        	lsView += '<div class="task-button-ctn">直播未开始</div>';
	        }
	        lsView += '</div></div></div>';
	        
	        $('.details-ctn').append(lsView);
	        $('.icon').circleProgress({
			    value: 0.75,
			    size: 42,
			    fill: '#188eee',
			  	emptyFill: '#a3d2f8'
			});
		});
	}
	
	function diffDate(d1, d2){
		var hourDiff = d2.getTime() - d1.getTime();
		return hourDiff / 60 / 1000; 
	}
	
	function updatePage(){
		if(pageIndex == 0){
			prevBtn.addClass('hide');
		}else{
			prevBtn.removeClass('hide');
		}
		
		if(tabCount * (1 + pageIndex) >= totalLessonCount){
			nextBtn.addClass('hide');
		}else{
			nextBtn.removeClass('hide');
		}
		
		$.each($('.tab-item-ctn'), function(index, e){
			if(index >= tabCount * pageIndex && index < tabCount * (1 + pageIndex)){
				$('.tab-item-ctn').eq(index).removeClass('hide');
			}else{
				$('.tab-item-ctn').eq(index).addClass('hide');
			}
			$(this).removeClass('active');
		});
		
		var activeTab = $('.tab-item-ctn').eq(pageIndex * tabCount);
		activeTab.addClass('active');
		
		var lessonId = activeTab.attr('data-ID');
		
		if (!(lessonId in lessonMap)){
			loadLessonSession(lessonId);
		}else{
			updateSessionView(lessonMap[lessonId]);
		}
	}
	
   	</script>
}